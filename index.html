<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4361ee">
    <title>å­¦ä¹ ä»»åŠ¡ç®¡ç†å™¨</title>
    
    <!-- æ ¸å¿ƒCSSå†…è” -->
    <style>
        /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #667eea, #764ba2); height: 100vh; overflow: hidden; }
        
        /* åŠ è½½åŠ¨ç”» */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 9999; transition: opacity 0.3s;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: white;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* åº”ç”¨å®¹å™¨ */
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        /* å¤´éƒ¨ */
        header { 
            background: linear-gradient(135deg, #4361ee, #3a0ca3); 
            color: white; padding: 12px 15px; flex-shrink: 0;
        }
        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        h1 { font-size: 18px; display: flex; align-items: center; gap: 6px; }
        .header-actions { display: flex; gap: 5px; }
        .header-btn {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 5px 10px; border-radius: 6px; font-size: 11px;
            cursor: pointer; display: flex; align-items: center; gap: 3px;
        }
        
        /* ç»Ÿè®¡æ•°æ® */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .stat-item { text-align: center; background: rgba(255,255,255,0.1); padding: 6px 3px; border-radius: 8px; }
        .stat-number { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .stat-label { font-size: 9px; opacity: 0.9; }
        
        /* ä»»åŠ¡åŒºåŸŸ */
        .task-section { flex: 1; padding: 12px 15px; overflow-y: auto; background: white; }
        .task-list { display: flex; flex-direction: column; gap: 8px; }
        
        /* ç­›é€‰æŒ‰é’® */
        .filter-buttons { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { 
            padding: 6px 12px; border: 2px solid #e2e8f0; background: white; 
            border-radius: 16px; color: #64748b; font-size: 13px; white-space: nowrap; flex-shrink: 0;
        }
        .filter-btn.active { background: #4361ee; color: white; border-color: #4361ee; }
        
        /* ä»»åŠ¡é¡¹ */
        .task-item {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 12px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            border-left: 4px solid #4361ee; transition: transform 0.2s;
        }
        .task-item:active { transform: scale(0.98); }
        .task-item.completed {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-left-color: #10b981;
        }
        
        /* å¤é€‰æ¡† */
        .task-checkbox {
            width: 18px; height: 18px; min-width: 18px; border: 2px solid #4361ee; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer;
        }
        .task-checkbox.checked { background: #10b981; border-color: #10b981; }
        .task-checkbox.checked::after { content: "âœ“"; color: white; font-weight: bold; font-size: 11px; }
        
        /* ä»»åŠ¡å†…å®¹ */
        .task-content { flex: 1; min-width: 0; overflow: hidden; }
        .task-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .task-meta { font-size: 11px; color: #64748b; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        /* å¾½ç«  */
        .video-badge { background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 10px; font-size: 10px; }
        .video-link-badge { background: #dbeafe; color: #1d4ed8; padding: 2px 6px; border-radius: 10px; font-size: 10px; }
        .status-badge { padding: 2px 6px; border-radius: 10px; font-size: 10px; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        
        /* åˆ é™¤æŒ‰é’® */
        .delete-btn {
            padding: 5px 10px; background: #fee2e2; color: #dc2626; border: none;
            border-radius: 6px; font-size: 11px; flex-shrink: 0; cursor: pointer;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state { text-align: center; padding: 40px 20px; color: #64748b; }
        .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
        
        /* æ·»åŠ è¡¨å• */
        .add-form {
            padding: 12px 15px; background: #f9fafb; border-top: 1px solid #e5e7eb;
            flex-shrink: 0; display: none;
        }
        .add-form.show { display: block; }
        .form-row { display: flex; flex-direction: column; gap: 8px; }
        .task-input {
            width: 100%; padding: 10px 12px; border: 2px solid #4361ee; border-radius: 8px;
            font-size: 14px; background: white;
        }
        .button-group { display: flex; gap: 8px; flex-wrap: wrap; }
        button {
            padding: 10px 16px; background: #4361ee; color: white; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .upload-btn { background: #e0e7ff; color: #4f46e5; padding: 10px 12px; }
        .link-btn { background: #dbeafe; color: #1d4ed8; padding: 10px 12px; }
        .link-btn.active { background: #3b82f6; color: white; }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            display: flex; padding: 12px 15px; background: #f9fafb;
            border-top: 1px solid #e5e7eb; gap: 8px; flex-shrink: 0;
        }
        .control-btn {
            flex: 1; padding: 12px; background: #4361ee; color: white; border: none;
            border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        
        /* åˆ†äº«é¢æ¿ */
        .share-panel {
            background: rgba(255, 255, 255, 0.95); border-radius: 8px; margin-top: 8px;
            padding: 10px; display: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .share-panel.show { display: block; }
        .share-title { text-align: center; margin-bottom: 8px; color: #4361ee; font-size: 13px; font-weight: 600; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .share-btn {
            padding: 6px 8px; border: none; border-radius: 6px; font-size: 10px; font-weight: 500;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px;
            min-height: 45px; justify-content: center;
        }
        .share-icon { font-size: 14px; }
        .share-label { font-size: 9px; }
        .share-btn.export { background: #10b981; color: white; }
        .share-btn.import { background: #3b82f6; color: white; }
        .share-btn.share-link { background: #ec4899; color: white; }
        .share-btn.text { background: #f59e0b; color: white; }
        .share-btn.html { background: #8b5cf6; color: white; }
        .share-btn.video-list { background: #06b6d4; color: white; }
        
        /* æ¨¡æ€æ¡†åŸºç¡€ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white; width: 90%; max-width: 400px; border-radius: 12px;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3); color: white;
            padding: 15px; text-align: center; position: relative;
        }
        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-close {
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2);
            border: none; color: white; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .modal-body { padding: 20px; }
        
        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 16px;
            border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <!-- åŠ è½½å±å¹• -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>åŠ è½½ä¸­...</div>
    </div>
    
    <!-- ä¸»åº”ç”¨ -->
    <div class="app-container">
        <header>
            <div class="header-top">
                <h1>ğŸ“š æ¯æ—¥å­¦ä¹ </h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="toggleSharePanel()">
                        <span>ğŸ“¤</span>
                        <span>åˆ†äº«</span>
                    </button>
                    <button class="header-btn" onclick="showVideoList()">
                        <span>ğŸ¬</span>
                        <span>è§†é¢‘</span>
                    </button>
                </div>
            </div>
            
            <!-- åˆ†äº«é¢æ¿ -->
            <div class="share-panel" id="sharePanel">
                <div class="share-title">ğŸ“¤ åˆ†äº«ä¸å¯¼å‡º</div>
                <div class="share-grid">
                    <button class="share-btn export" onclick="exportTasks()">
                        <span class="share-icon">ğŸ“¥</span>
                        <span class="share-label">å¯¼å‡ºæ•°æ®</span>
                    </button>
                    <button class="share-btn import" onclick="document.getElementById('importFile').click()">
                        <span class="share-icon">ğŸ“¤</span>
                        <span class="share-label">å¯¼å…¥æ•°æ®</span>
                    </button>
                    <button class="share-btn share-link" onclick="generateShareableLink()">
                        <span class="share-icon">ğŸ”—</span>
                        <span class="share-label">åˆ†äº«é“¾æ¥</span>
                    </button>
                    <button class="share-btn text" onclick="shareAsText()">
                        <span class="share-icon">ğŸ“‹</span>
                        <span class="share-label">å¤åˆ¶æ–‡æœ¬</span>
                    </button>
                    <button class="share-btn html" onclick="generateHTMLReport()">
                        <span class="share-icon">ğŸ“„</span>
                        <span class="share-label">ç”ŸæˆæŠ¥å‘Š</span>
                    </button>
                    <button class="share-btn video-list" onclick="showVideoList()">
                        <span class="share-icon">ğŸ¬</span>
                        <span class="share-label">è§†é¢‘æ¸…å•</span>
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json,.txt" style="display:none;" onchange="importTasks(event)">
            </div>
            
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="points">0</div>
                    <div class="stat-label">ç§¯åˆ†</div>
                </div>
            </div>
        </header>
        
        <!-- ä»»åŠ¡åŒºåŸŸ -->
        <div class="task-section">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterTasks('all')">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterTasks('pending')">è¿›è¡Œä¸­</button>
                <button class="filter-btn" onclick="filterTasks('completed')">å·²å®Œæˆ</button>
            </div>
            
            <div class="task-list" id="taskList"></div>
            
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="empty-icon">ğŸ“</div>
                <h3>è¿˜æ²¡æœ‰å­¦ä¹ ä»»åŠ¡</h3>
                <p>ç‚¹å‡»ä¸‹æ–¹"æ·»åŠ ä»»åŠ¡"æŒ‰é’®å¼€å§‹</p>
            </div>
        </div>
        
        <!-- æ·»åŠ è¡¨å• -->
        <div class="add-form" id="addForm">
            <div class="form-row">
                <input type="text" id="taskInput" class="task-input" placeholder="è¾“å…¥å­¦ä¹ ä»»åŠ¡..." autocomplete="off">
                <input type="url" id="videoUrlInput" class="video-url-input" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥ (å¯é€‰)" autocomplete="off" style="display:none;">
                <div class="button-group">
                    <button class="upload-btn" onclick="addVideoFile()">
                        <span>ğŸ“</span>
                        <span>æ·»åŠ è§†é¢‘</span>
                    </button>
                    <button class="link-btn" id="linkBtn" onclick="toggleVideoUrl()">
                        <span>ğŸ”—</span>
                        <span>è§†é¢‘é“¾æ¥</span>
                    </button>
                    <button id="addBtn">
                        <span>+</span>
                        <span>æ·»åŠ ä»»åŠ¡</span>
                    </button>
                </div>
                <input type="file" id="videoUpload" accept="video/*" style="display:none;" onchange="handleVideoFile(event)">
                <div id="fileInfo" class="file-info" style="display:none; margin-top:8px; padding:6px 10px; background:#f1f5f9; border-radius:6px; font-size:12px;"></div>
                <div id="linkInfo" class="link-info" style="display:none; margin-top:8px; padding:6px 10px; background:#eff6ff; border-radius:6px; font-size:12px;"></div>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="control-buttons">
            <button class="control-btn" onclick="toggleAddForm()">
                <span>+</span>
                <span>æ·»åŠ ä»»åŠ¡</span>
            </button>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modalContainer"></div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- æ ¸å¿ƒJS -->
    <script>
        // ==================== æé€Ÿåˆå§‹åŒ– ====================
        let tasks = [];
        let totalPoints = 0;
        let currentFilter = 'all';
        let isStudentMode = false;
        let selectedVideoFile = null;
        let selectedVideoUrl = null;
        let useVideoUrl = false;
        
        // å¹³å°é…ç½®ï¼ˆç®€ç‰ˆï¼‰
        const platforms = {
            bilibili: { name: 'å“”å“©å“”å“©', icon: 'ğŸ“º', color: '#fb7299' },
            douyin: { name: 'æŠ–éŸ³', icon: 'ğŸµ', color: '#000' },
            tencent: { name: 'è…¾è®¯è§†é¢‘', icon: 'ğŸ¬', color: '#0052d9' },
            youku: { name: 'ä¼˜é…·', icon: 'ğŸ“¹', color: '#ff6400' },
            baidu: { name: 'ç™¾åº¦ç½‘ç›˜', icon: 'â˜ï¸', color: '#2932e1' },
            generic: { name: 'å…¶ä»–é“¾æ¥', icon: 'ğŸ”—', color: '#64748b' }
        };
        
        // 1. å¿«é€Ÿåˆå§‹åŒ–
        function fastInit() {
            console.time('åˆå§‹åŒ–æ—¶é—´');
            
            // ç«‹å³éšè—åŠ è½½å±å¹•
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 300);
            }, 300);
            
            // å¿«é€ŸåŠ è½½æœ¬åœ°æ•°æ®
            try {
                const savedTasks = localStorage.getItem('studyTasks');
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                }
                
                const savedPoints = localStorage.getItem('totalPoints');
                if (savedPoints) {
                    totalPoints = parseInt(savedPoints);
                }
            } catch (e) {
                console.warn('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', e);
            }
            
            // æ£€æŸ¥URLå‚æ•°ï¼ˆå­¦ç”Ÿæ¨¡å¼ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('share') === 'true') {
                const shareData = urlParams.get('data');
                if (shareData) {
                    try {
                        const decodedData = decodeURIComponent(shareData);
                        const data = JSON.parse(decodedData);
                        if (data.tasks) {
                            tasks = data.tasks;
                            isStudentMode = true;
                            // å­¦ç”Ÿæ¨¡å¼ï¼šéšè—ç¼–è¾‘åŠŸèƒ½
                            document.querySelector('.control-buttons').style.display = 'none';
                            document.querySelector('h1').innerHTML = 'ğŸ“š å­¦ä¹ ä»»åŠ¡æ‰“å¡';
                            document.querySelector('.header-actions').style.display = 'none';
                        }
                    } catch (e) {
                        console.warn('åŠ è½½åˆ†äº«æ•°æ®å¤±è´¥:', e);
                    }
                }
            }
            
            // ç«‹å³æ¸²æŸ“ç•Œé¢
            renderTasks();
            setupEvents();
            
            console.timeEnd('åˆå§‹åŒ–æ—¶é—´');
        }
        
        // 2. è®¾ç½®äº‹ä»¶
        function setupEvents() {
            // æ·»åŠ ä»»åŠ¡æŒ‰é’®
            document.getElementById('addBtn').addEventListener('click', addTask);
            
            // è¾“å…¥æ¡†å›è½¦
            document.getElementById('taskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            
            // è§†é¢‘é“¾æ¥è¾“å…¥
            document.getElementById('videoUrlInput').addEventListener('input', function() {
                if (this.value.trim()) {
                    selectedVideoUrl = this.value;
                    selectedVideoFile = null;
                    document.getElementById('fileInfo').style.display = 'none';
                    document.getElementById('linkInfo').style.display = 'block';
                    document.getElementById('linkInfo').textContent = 'ğŸ”— è§†é¢‘é“¾æ¥å·²è®¾ç½®';
                } else {
                    selectedVideoUrl = null;
                    document.getElementById('linkInfo').style.display = 'none';
                }
            });
        }
        
        // 3. æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyState');
            
            let filteredTasks = tasks;
            if (currentFilter === 'pending') {
                filteredTasks = tasks.filter(t => !t.completed);
            } else if (currentFilter === 'completed') {
                filteredTasks = tasks.filter(t => t.completed);
            }
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                taskList.innerHTML = '';
                
                filteredTasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = `task-item ${task.completed ? 'completed' : ''}`;
                    
                    // è§†é¢‘å¾½ç« 
                    let videoBadge = '';
                    if (task.video) {
                        if (task.videoType === 'url') {
                            const platform = detectPlatform(task.videoUrl);
                            if (platform && platforms[platform]) {
                                videoBadge = `<span style="background:${platforms[platform].color}10;color:${platforms[platform].color};padding:2px 6px;border-radius:10px;font-size:10px;border:1px solid ${platforms[platform].color}30">${platforms[platform].icon} ${platforms[platform].name}</span>`;
                            } else {
                                videoBadge = '<span class="video-link-badge">ğŸ”— åœ¨çº¿è§†é¢‘</span>';
                            }
                        } else {
                            videoBadge = '<span class="video-badge">ğŸ¬ æœ¬åœ°è§†é¢‘</span>';
                        }
                    }
                    
                    // åˆ é™¤æŒ‰é’®ï¼ˆéå­¦ç”Ÿæ¨¡å¼æ˜¾ç¤ºï¼‰
                    let deleteButton = '';
                    if (!isStudentMode) {
                        deleteButton = `<button class="delete-btn" onclick="deleteTask(${task.id})">åˆ é™¤</button>`;
                    }
                    
                    div.innerHTML = `
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                        <div class="task-content" ${task.video ? `onclick="playVideo(${task.id})" style="cursor:pointer;"` : ''}>
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                ${videoBadge}
                                <span class="status-badge ${task.completed ? 'status-completed' : 'status-pending'}">
                                    ${task.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}
                                </span>
                                <span>${formatDate(task.createdAt)}</span>
                            </div>
                        </div>
                        ${deleteButton}
                    `;
                    taskList.appendChild(div);
                });
            }
            
            updateStats();
        }
        
        // 4. æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const total = tasks.length;
            const pending = tasks.filter(t => !t.completed).length;
            const completed = tasks.filter(t => t.completed).length;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('points').textContent = totalPoints;
        }
        
        // 5. ç­›é€‰ä»»åŠ¡
        function filterTasks(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }
        
        // 6. åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const wasCompleted = task.completed;
            task.completed = !task.completed;
            
            // ä¿å­˜æ•°æ®
            saveData();
            
            // å¢åŠ ç§¯åˆ†
            if (!wasCompleted && task.completed) {
                totalPoints += 1;
                saveData();
                showToast('ä»»åŠ¡å®Œæˆï¼+1åˆ†');
            }
            
            renderTasks();
        }
        
        // 7. åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤ä»»åŠ¡ä¸ä¼šå‡å°‘å·²è·å¾—çš„ç§¯åˆ†ã€‚')) return;
            
            tasks = tasks.filter(t => t.id !== taskId);
            saveData();
            renderTasks();
            showToast('ä»»åŠ¡å·²åˆ é™¤');
        }
        
        // 8. æ·»åŠ ä»»åŠ¡
        function addTask() {
            const input = document.getElementById('taskInput');
            const title = input.value.trim();
            
            if (!title) {
                showToast('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜');
                return;
            }
            
            const hasVideo = !!selectedVideoFile || !!selectedVideoUrl;
            const videoType = selectedVideoFile ? 'local' : (selectedVideoUrl ? 'url' : null);
            const videoUrl = selectedVideoUrl;
            
            // æ£€æµ‹å¹³å°
            let platform = null;
            if (videoUrl) {
                platform = detectPlatform(videoUrl);
            }
            
            const task = {
                id: Date.now(),
                title: title,
                completed: false,
                video: hasVideo,
                videoType: videoType,
                videoUrl: videoUrl,
                platform: platform,
                createdAt: new Date().toISOString(),
                status: 'pending'
            };
            
            tasks.push(task);
            saveData();
            
            // é‡ç½®è¡¨å•
            input.value = '';
            selectedVideoFile = null;
            selectedVideoUrl = null;
            useVideoUrl = false;
            document.getElementById('videoUrlInput').style.display = 'none';
            document.getElementById('videoUrlInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('linkInfo').style.display = 'none';
            document.getElementById('linkBtn').classList.remove('active');
            
            renderTasks();
            showToast('ä»»åŠ¡æ·»åŠ æˆåŠŸ');
            
            // æ”¶èµ·è¡¨å•
            toggleAddForm();
        }
        
        // 9. ä¿å­˜æ•°æ®
        function saveData() {
            try {
                localStorage.setItem('studyTasks', JSON.stringify(tasks));
                localStorage.setItem('totalPoints', totalPoints.toString());
            } catch (e) {
                console.warn('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // 10. æ·»åŠ è§†é¢‘æ–‡ä»¶
        function addVideoFile() {
            document.getElementById('videoUpload').click();
        }
        
        function handleVideoFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedVideoFile = file;
            selectedVideoUrl = null;
            useVideoUrl = false;
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileInfo').textContent = `ğŸ“ ${file.name} (${formatFileSize(file.size)})`;
            document.getElementById('linkInfo').style.display = 'none';
            document.getElementById('videoUrlInput').style.display = 'none';
            document.getElementById('linkBtn').classList.remove('active');
            
            event.target.value = '';
        }
        
        // 11. åˆ‡æ¢è§†é¢‘é“¾æ¥è¾“å…¥
        function toggleVideoUrl() {
            useVideoUrl = !useVideoUrl;
            if (useVideoUrl) {
                document.getElementById('videoUrlInput').style.display = 'block';
                document.getElementById('linkBtn').classList.add('active');
                setTimeout(() => document.getElementById('videoUrlInput').focus(), 100);
            } else {
                document.getElementById('videoUrlInput').style.display = 'none';
                document.getElementById('linkBtn').classList.remove('active');
                selectedVideoUrl = null;
                document.getElementById('linkInfo').style.display = 'none';
            }
        }
        
        // 12. æ’­æ”¾è§†é¢‘
        function playVideo(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.video) return;
            
            if (task.videoType === 'url' && task.videoUrl) {
                window.open(task.videoUrl, '_blank');
            } else {
                showToast('æœ¬åœ°è§†é¢‘æš‚ä¸æ”¯æŒåœ¨çº¿æ’­æ”¾');
            }
        }
        
        // 13. æ˜¾ç¤º/éšè—æ·»åŠ è¡¨å•
        function toggleAddForm() {
            if (isStudentMode) return;
            
            const addForm = document.getElementById('addForm');
            if (addForm.classList.contains('show')) {
                addForm.classList.remove('show');
            } else {
                addForm.classList.add('show');
                setTimeout(() => document.getElementById('taskInput').focus(), 100);
            }
        }
        
        // 14. åˆ‡æ¢åˆ†äº«é¢æ¿
        function toggleSharePanel() {
            const sharePanel = document.getElementById('sharePanel');
            if (sharePanel.classList.contains('show')) {
                sharePanel.classList.remove('show');
            } else {
                sharePanel.classList.add('show');
            }
        }
        
        // ==================== åˆ†äº«åŠŸèƒ½ ====================
        
        // 15. å¯¼å‡ºä»»åŠ¡
        function exportTasks() {
            if (tasks.length === 0) {
                showToast('æ²¡æœ‰ä»»åŠ¡å¯ä»¥å¯¼å‡º');
                return;
            }
            
            const data = {
                tasks: tasks,
                exportInfo: {
                    exportDate: new Date().toISOString(),
                    totalTasks: tasks.length,
                    completedTasks: tasks.filter(t => t.completed).length,
                    totalPoints: totalPoints
                }
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ä¹ ä»»åŠ¡_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            showToast(`å·²å¯¼å‡º ${tasks.length} ä¸ªä»»åŠ¡`);
            toggleSharePanel();
        }
        
        // 16. å¯¼å…¥ä»»åŠ¡
        function importTasks(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.tasks || !Array.isArray(data.tasks)) {
                        throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    const taskCount = data.tasks.length;
                    
                    if (!confirm(`è¦å¯¼å…¥ ${taskCount} ä¸ªä»»åŠ¡å—ï¼Ÿ`)) {
                        return;
                    }
                    
                    // åˆå¹¶ä»»åŠ¡
                    tasks = [...tasks, ...data.tasks.map(task => ({
                        ...task,
                        id: task.id || Date.now() + Math.random()
                    }))];
                    
                    saveData();
                    renderTasks();
                    showToast(`æˆåŠŸå¯¼å…¥ ${taskCount} ä¸ªä»»åŠ¡`);
                    toggleSharePanel();
                    
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
        
        // 17. ç”Ÿæˆåˆ†äº«é“¾æ¥
        function generateShareableLink() {
            if (tasks.length === 0) {
                showToast('æ²¡æœ‰ä»»åŠ¡å¯ä»¥åˆ†äº«');
                return;
            }
            
            // åˆ›å»ºå¯åˆ†äº«çš„ä»»åŠ¡æ•°æ®ï¼ˆå»é™¤æœ¬åœ°è§†é¢‘ï¼‰
            const shareableTasks = tasks.map(task => {
                const shareableTask = {
                    id: task.id,
                    title: task.title,
                    completed: false, // åˆ†äº«æ—¶é‡ç½®å®ŒæˆçŠ¶æ€
                    video: task.video,
                    videoType: task.videoType,
                    videoUrl: task.videoUrl,
                    platform: task.platform,
                    createdAt: task.createdAt,
                    status: 'pending'
                };
                
                // å¦‚æœæ˜¯æœ¬åœ°è§†é¢‘ï¼Œæ ‡è®°ä¸ºä¸æ”¯æŒåœ¨çº¿æ’­æ”¾
                if (task.videoType === 'local') {
                    shareableTask.video = false;
                    shareableTask.note = 'æœ¬åœ°è§†é¢‘æ— æ³•åœ¨çº¿æ’­æ”¾';
                }
                
                return shareableTask;
            });
            
            const shareData = {
                tasks: shareableTasks,
                shareInfo: {
                    shareDate: new Date().toISOString(),
                    totalTasks: tasks.length,
                    message: 'å­¦ç”Ÿå¯ä»¥ä½¿ç”¨æ­¤é“¾æ¥æŸ¥çœ‹ä»»åŠ¡'
                }
            };
            
            const encodedData = encodeURIComponent(JSON.stringify(shareData));
            const currentUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${currentUrl}?share=true&data=${encodedData}`;
            
            // æ˜¾ç¤ºåˆ†äº«é“¾æ¥æ¨¡æ€æ¡†
            showShareLinkModal(shareUrl);
            toggleSharePanel();
        }
        
        // 18. æ˜¾ç¤ºåˆ†äº«é“¾æ¥æ¨¡æ€æ¡†
        function showShareLinkModal(shareUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ğŸ”— åˆ†äº«å­¦ä¹ ä»»åŠ¡</div>
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom:15px; color:#64748b; font-size:13px; text-align:center;">
                            å¤åˆ¶æ­¤é“¾æ¥åˆ†äº«ç»™å­¦ç”Ÿï¼Œå­¦ç”Ÿå¯ä»¥ç›´æ¥è§‚çœ‹è§†é¢‘å¹¶è¿›è¡Œæ‰“å¡
                        </div>
                        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">
                            <div style="word-break:break-all; color:#1e293b; font-size:13px; margin-bottom:8px;">${shareUrl}</div>
                            <div style="font-size:11px; color:#64748b;">
                                å­¦ç”Ÿæ‰“å¼€æ­¤é“¾æ¥å³å¯æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡å’Œè§†é¢‘
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="copyToClipboard('${shareUrl}'); this.parentElement.parentElement.remove()" style="flex:1; padding:10px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
                                ğŸ“‹ å¤åˆ¶é“¾æ¥
                            </button>
                            <button onclick="window.open('${shareUrl}', '_blank'); this.parentElement.parentElement.remove()" style="flex:1; padding:10px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
                                ğŸ”— æ‰“å¼€é¢„è§ˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').appendChild(modal);
        }
        
        // 19. å¤åˆ¶ä¸ºæ–‡æœ¬
        function shareAsText() {
            if (tasks.length === 0) {
                showToast('æ²¡æœ‰ä»»åŠ¡å¯ä»¥åˆ†äº«');
                return;
            }
            
            let text = "ğŸ“š å­¦ä¹ ä»»åŠ¡æ¸…å•\n";
            text += "=".repeat(30) + "\n";
            text += "ç”Ÿæˆæ—¶é—´ï¼š" + new Date().toLocaleString() + "\n";
            text += "æ€»ä»»åŠ¡ï¼š" + tasks.length;
            text += " | è¿›è¡Œä¸­ï¼š" + tasks.filter(t => !t.completed).length;
            text += " | å·²å®Œæˆï¼š" + tasks.filter(t => t.completed).length;
            text += " | æ€»ç§¯åˆ†ï¼š" + totalPoints;
            text += "\n" + "=".repeat(30) + "\n\n";
            
            tasks.forEach((task, index) => {
                text += `${index + 1}. ${task.title}\n`;
                text += `   çŠ¶æ€ï¼š${task.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}\n`;
                if (task.video) {
                    if (task.videoType === 'url') {
                        const platform = detectPlatform(task.videoUrl);
                        text += `   è§†é¢‘ï¼š${platform ? platforms[platform].name : 'åœ¨çº¿è§†é¢‘'} (é“¾æ¥)\n`;
                    } else {
                        text += `   è§†é¢‘ï¼šæœ¬åœ°è§†é¢‘\n`;
                    }
                }
                text += "\n";
            });
            
            copyToClipboard(text);
            showToast('ä»»åŠ¡æ¸…å•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            toggleSharePanel();
        }
        
        // 20. ç”ŸæˆHTMLæŠ¥å‘Š
        function generateHTMLReport() {
            if (tasks.length === 0) {
                showToast('æ²¡æœ‰ä»»åŠ¡å¯ä»¥ç”ŸæˆæŠ¥å‘Š');
                return;
            }
            
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>å­¦ä¹ ä»»åŠ¡æŠ¥å‘Š</title><style>
                body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: #f8fafc; }
                .container { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
                .task-item { margin: 12px 0; padding: 12px; border-left: 4px solid #4361ee; background: #f8fafc; border-radius: 5px; }
                .task-item.completed { border-color: #10b981; background: #f0fdf4; }
                .task-title { font-weight: bold; font-size: 15px; margin-bottom: 5px; color: #1e293b; }
                .task-meta { font-size: 12px; color: #64748b; display: flex; flex-wrap: wrap; gap: 8px; }
                .stats { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
            </style></head><body><div class="container"><div class="header">
                <h1>ğŸ“š å­¦ä¹ ä»»åŠ¡æŠ¥å‘Š</h1>
                <div class="stats">
                    <div>æ€»ä»»åŠ¡: ${tasks.length}</div>
                    <div>è¿›è¡Œä¸­: ${tasks.filter(t => !t.completed).length}</div>
                    <div>å·²å®Œæˆ: ${tasks.filter(t => t.completed).length}</div>
                    <div>æ€»ç§¯åˆ†: ${totalPoints}</div>
                </div>
                <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
            </div>`;
            
            tasks.forEach((task, index) => {
                html += `<div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-title">${index + 1}. ${task.title}</div>
                    <div class="task-meta">
                        <span style="padding:2px 6px;border-radius:10px;font-size:11px;background:${task.completed ? '#d1fae5' : '#fef3c7'};color:${task.completed ? '#065f46' : '#92400e'}">
                            ${task.completed ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}
                        </span>`;
                
                if (task.video) {
                    if (task.videoType === 'url') {
                        html += `<span style="background:#dbeafe;color:#1d4ed8;padding:2px 6px;border-radius:10px;font-size:11px;">ğŸ”— åœ¨çº¿è§†é¢‘</span>`;
                    } else {
                        html += `<span style="background:#e0e7ff;color:#4f46e5;padding:2px 6px;border-radius:10px;font-size:11px;">ğŸ¬ æœ¬åœ°è§†é¢‘</span>`;
                    }
                }
                
                html += `<span>åˆ›å»ºæ—¶é—´: ${formatDate(task.createdAt)}</span></div></div>`;
            });
            
            html += `</div></body></html>`;
            
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ä¹ ä»»åŠ¡æŠ¥å‘Š_${new Date().toLocaleDateString().replace(/\//g, '-')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            showToast('HTMLæŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸‹è½½');
            toggleSharePanel();
        }
        
        // 21. æ˜¾ç¤ºè§†é¢‘æ¸…å•
        function showVideoList() {
            const videoTasks = tasks.filter(task => task.video);
            
            if (videoTasks.length === 0) {
                showToast('æ²¡æœ‰è§†é¢‘ä»»åŠ¡');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ğŸ¬ è§†é¢‘æ¸…å• (${videoTasks.length})</div>
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                        ${videoTasks.map(task => `
                            <div style="display:flex; align-items:center; padding:10px; border-bottom:1px solid #e5e7eb; cursor:pointer;" onclick="playVideo(${task.id}); this.parentElement.parentElement.parentElement.remove()">
                                <div style="font-size:18px; margin-right:10px; color:#06b6d4;">${task.videoType === 'url' ? 'ğŸ”—' : 'ğŸ¬'}</div>
                                <div style="flex:1; min-width:0;">
                                    <div style="font-size:14px; color:#1e293b; margin-bottom:3px; font-weight:500;">${task.title}</div>
                                    <div style="font-size:11px; color:#64748b; display:flex; gap:8px; align-items:center;">
                                        <span style="padding:2px 6px; border-radius:10px; font-size:10px; background:${task.videoType === 'url' ? '#dbeafe' : '#e0e7ff'};color:${task.videoType === 'url' ? '#1d4ed8' : '#4f46e5'}">
                                            ${task.videoType === 'url' ? 'åœ¨çº¿è§†é¢‘' : 'æœ¬åœ°è§†é¢‘'}
                                        </span>
                                        <span>${formatDate(task.createdAt)}</span>
                                    </div>
                                </div>
                                <button style="padding:6px 12px; background:#06b6d4; color:white; border:none; border-radius:6px; font-size:12px; cursor:pointer;">æ’­æ”¾</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').appendChild(modal);
            toggleSharePanel();
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        // æ£€æµ‹å¹³å°
        function detectPlatform(url) {
            if (!url) return null;
            if (url.includes('bilibili.com')) return 'bilibili';
            if (url.includes('douyin.com')) return 'douyin';
            if (url.includes('v.qq.com')) return 'tencent';
            if (url.includes('youku.com')) return 'youku';
            if (url.includes('pan.baidu.com')) return 'baidu';
            return 'generic';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
                
                if (diffHours < 24) {
                    return `${diffHours}å°æ—¶å‰`;
                } else if (diffHours < 24 * 7) {
                    return `${Math.floor(diffHours / 24)}å¤©å‰`;
                } else {
                    return date.toLocaleDateString();
                }
            } catch (e) {
                return 'åˆšåˆš';
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            
            document.body.removeChild(textarea);
        }
        
        // æ˜¾ç¤ºToast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', fastInit);
        
        // é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', () => {
            saveData();
        });
    </script>
</body>
</html>